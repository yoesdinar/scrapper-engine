events {
    worker_connections 1024;
}

http {
    # Upstream definitions
    upstream controller {
        server controller:8080;
    }

    # Load balanced worker pool for external client traffic
    upstream worker_pool {
        least_conn;
        server worker1:8082;
        server worker2:8082;
        server worker3:8082;
    }

    upstream worker1 {
        server worker1:8082;
    }

    upstream worker2 {
        server worker2:8082;
    }

    upstream worker3 {
        server worker3:8082;
    }

    # Health check endpoint logging
    log_format healthcheck '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent';

    server {
        listen 80;
        server_name _;

        # Access and error logs
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # Root location - serve a simple homepage
        location = / {
            default_type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Configuration Management System</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #333; }
        .service { background: #f4f4f4; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .service h2 { margin-top: 0; color: #0066cc; }
        a { color: #0066cc; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .status { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Configuration Management System</h1>
    <p class="status">System Status: Online</p>
    
    <div class="service">
        <h2>Admin Panel (Controller)</h2>
        <p>Manage configurations and monitor agents</p>
        <ul>
            <li><a href="/admin/swagger/index.html">API Documentation (Swagger)</a></li>
            <li><a href="/admin/health">Health Check</a></li>
        </ul>
    </div>

    <div class="service">
        <h2>Worker 1</h2>
        <p>Configuration execution worker</p>
        <ul>
            <li><a href="/worker1/swagger/index.html">API Documentation</a></li>
            <li><a href="/worker1/health">Health Check</a></li>
        </ul>
    </div>

    <div class="service">
        <h2>Worker 2</h2>
        <p>Configuration execution worker</p>
        <ul>
            <li><a href="/worker2/swagger/index.html">API Documentation</a></li>
            <li><a href="/worker2/health">Health Check</a></li>
        </ul>
    </div>

    <div class="service">
        <h2>Worker 3</h2>
        <p>Configuration execution worker</p>
        <ul>
            <li><a href="/worker3/swagger/index.html">API Documentation</a></li>
            <li><a href="/worker3/health">Health Check</a></li>
        </ul>
    </div>

    <hr>
    <p><small>Configuration Management System v1.0 | Nginx Gateway</small></p>
</body>
</html>';
        }

        # Controller routes (Admin Panel)
        location /admin/ {
            proxy_pass http://controller/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeout settings
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Load balanced worker endpoint for external clients
        # External clients hit: http://localhost:8085/worker/hit
        # This distributes traffic across all workers automatically
        location /worker/ {
            # Strip /worker prefix and proxy to any available worker
            rewrite ^/worker/(.*)$ /$1 break;
            proxy_pass http://worker_pool;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Worker 1 routes (for direct access if needed)
        location /worker1/ {
            proxy_pass http://worker1/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Worker 2 routes
        location /worker2/ {
            proxy_pass http://worker2/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Worker 3 routes
        location /worker3/ {
            proxy_pass http://worker3/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Nginx health check
        location /nginx-health {
            access_log off;
            return 200 "nginx OK\n";
            add_header Content-Type text/plain;
        }

        # Load balancer health check
        location /health {
            access_log off;
            return 200 "Load Balancer OK\n";
            add_header Content-Type text/plain;
        }
    }
}
